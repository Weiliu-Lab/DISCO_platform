#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from __future__ import annotations

import argparse
from pathlib import Path

import pandas as pd

import matplotlib

matplotlib.use("Agg")
import matplotlib.pyplot as plt


ALL_MODELS_CSV_NAME = "all_models_rmse_complexity.csv"


def pareto_front_min(df: pd.DataFrame, xcol: str, ycol: str) -> pd.DataFrame:
    """二维 Pareto 前沿（第一前沿）：同时最小化 x 和 y。"""
    d = df.sort_values([xcol, ycol], ascending=[True, True]).reset_index(drop=True)

    best_y = float("inf")
    keep_idx: list[int] = []
    for i, r in d.iterrows():
        y = float(r[ycol])
        if y < best_y:
            keep_idx.append(i)
            best_y = y

    return d.loc[keep_idx].copy()


def main() -> int:
    parser = argparse.ArgumentParser(description="Plot RMSE vs Complexity and highlight Pareto front.")
    parser.add_argument("--input", default=ALL_MODELS_CSV_NAME, help="Input summary CSV (generated by SISSO_extract.py).")
    parser.add_argument("--rmse-max", type=float, default=None, help="Optional extra RMSE filter for plotting.")
    args = parser.parse_args()

    root = Path(".").resolve()
    csv_path = (root / str(args.input)).resolve()
    if not csv_path.exists():
        raise FileNotFoundError(
            f"Missing {csv_path.name}. Run SISSO_extract.py first to generate {ALL_MODELS_CSV_NAME}."
        )

    all_df = pd.read_csv(csv_path)
    if "complexity" not in all_df.columns or "RMSE" not in all_df.columns:
        raise RuntimeError(f"{csv_path.name} must contain columns: complexity, RMSE")

    all_df["RMSE"] = pd.to_numeric(all_df["RMSE"], errors="coerce")
    all_df["complexity"] = pd.to_numeric(all_df["complexity"], errors="coerce")
    all_df = all_df.dropna(subset=["complexity", "RMSE"]).copy()

    if args.rmse_max is not None:
        all_df = all_df[all_df["RMSE"] <= float(args.rmse_max)].copy()

    if all_df.empty:
        raise RuntimeError("No data left for plotting (after filtering).")

    pf = pareto_front_min(all_df, "complexity", "RMSE")
    pf.to_csv("pareto_front.csv", index=False)

    plt.figure()
    plt.scatter(all_df["complexity"], all_df["RMSE"], s=10, alpha=0.35, label="Models")
    plt.scatter(pf["complexity"], pf["RMSE"], s=45, marker="x", label="Pareto front")
    plt.plot(pf["complexity"], pf["RMSE"], linewidth=1)

    plt.xlabel("Model complexity")
    plt.ylabel("RMSE")
    plt.title("RMSE vs Complexity")
    plt.legend()
    plt.tight_layout()
    plt.savefig("rmse_complexity_scatter_pareto.png", dpi=300)

    print("[DONE] Wrote:")
    print("  - pareto_front.csv")
    print("  - rmse_complexity_scatter_pareto.png")
    print(f"[INFO] Input: {csv_path.name}")

    return 0


if __name__ == "__main__":
    raise SystemExit(main())
